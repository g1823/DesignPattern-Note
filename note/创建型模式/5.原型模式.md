## å¼•å…¥

â€‹	ç”±äºé‚®ä»¶å¯¹è±¡åŒ…å«çš„å†…å®¹è¾ƒå¤šï¼ˆå¦‚å‘é€è€…ã€æ¥æ”¶è€…ã€æ ‡é¢˜ã€å†…å®¹ã€æ—¥æœŸã€é™„ä»¶ç­‰ï¼‰ï¼ŒæŸç³»ç»Ÿä¸­ç°éœ€è¦æä¾›ä¸€ä¸ªé‚®å¤åˆ¶åŠŸèƒ½ï¼Œå¯¹äºå·²ç»åˆ›å»ºå¥½çš„é‚®ä»¶å¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡å¤åˆ¶çš„æ–¹å¼åˆ›å»ºä¸€ä¸ªæ–°çš„é‚®ä»¶å¯¹è±¡ï¼Œå¦‚æœéœ€è¦æ”¹å˜æŸéƒ¨åˆ†å†…å®¹ï¼Œæ— é¡»ä¿®æ”¹åŸå§‹çš„é‚®ä»¶å¯¹è±¡ï¼Œåªéœ€è¦ä¿®æ”¹å¤åˆ¶åå¾—åˆ°çš„é‚®ä»¶å¯¹è±¡å³å¯ã€‚

## ä¼ ç»Ÿæ–¹æ³•

â€‹	ä¼ ç»Ÿæ–¹æ³•ï¼Œæƒ³è¦åˆ›å»ºå¤šä¸ªå†…å®¹å·®ä¸å¤šçš„é‚®ä»¶ï¼Œæˆ‘ä»¬éœ€è¦å¤šæ¬¡ä½¿ç”¨newå…³é”®å­—æ¥åˆ›å»ºï¼Œå¹¶åˆ†åˆ«å¡«å……å¯¹åº”çš„å±æ€§ï¼Œå°±æ˜¯å†…å®¹å·®ä¸å¤šã€‚

ä»£ç ï¼š

~~~ java
// é‚®ä»¶
public class Mail {
    private String title;

    private String content;

    private Attachment attachment;

    private Date date;
}

// é™„ä»¶
public class Attachment {
    private String name;

    private String content;
}
~~~

~~~ java
// å®¢æˆ·ç«¯
public class Client {
    public static void main(String[] args) {
        Date date = new Date();
        Attachment attachment = new Attachment();
        attachment.setName("é™„ä»¶");
        attachment.setContent("é™„ä»¶å†…å®¹");

        Mail mail1 = new Mail();
        mail1.setTitle("é‚®ä»¶1");
        mail1.setContent("é‚®ä»¶å†…å®¹");
        mail1.setDate(date);
        mail1.setAttachment(attachment);

        Mail mail2 = new Mail();
        mail2.setTitle("é‚®ä»¶2");
        mail2.setContent("é‚®ä»¶å†…å®¹");
        mail2.setDate(date);
        mail2.setAttachment(attachment);
        
        System.out.println("é‚®ä»¶1ï¼š" + mail1);
        System.out.println("é‚®ä»¶2ï¼š" + mail2);
    }
}
~~~

## åŸå‹æ¨¡å¼

### 1ã€åˆ†æ

åŸå‹æ¨¡å¼ç»“æ„è¾ƒä¸ºç®€å•ï¼Œåœ¨å…¶ç»“æ„ä¸­æä¾›äº†ä¸€ä¸ªæŠ½è±¡åŸå‹ç±»ã€‚ä¸‹é¢å°†ä»‹ç»å¹¶åˆ†æå…¶æ¨¡å¼ç»“æ„ã€‚

åŸå‹æ¨¡å¼åŒ…å«å¦‚ä¸‹è§’è‰²ï¼š

1. Prototypeï¼ˆæŠ½è±¡åŸå‹ç±»ï¼‰
   æŠ½è±¡åŸå‹ç±»æ˜¯å®šä¹‰å…·æœ‰å…‹éš†è‡ªå·²çš„æ–¹æ³•çš„æ¥å£ï¼Œæ˜¯æ‰€æœ‰å…·ä½“åŸå‹ç±»çš„å…¬å…±çˆ¶ç±»ï¼Œå¯ä»¥æ˜¯æŠ½è±¡ç±»ï¼Œä¹Ÿå¯ä»¥æ˜¯å£ã€‚

2. ConcretePrototypeï¼ˆå…·ä½“åŸå‹ç±»ï¼‰
   å…·ä½“åŸå‹ç±»å®ç°å…·ä½“çš„å…‹éš†æ–¹æ³•ï¼Œåœ¨å…‹éš†æ–¹æ³•ä¸­è¿”å›è‡ªå·±çš„ä¸€ä¸ªå…‹éš†å¯¹è±¡ã€‚
3. Clientï¼ˆå®¢æˆ·ç±»ï¼‰
   å®¢æˆ·ç±»è®©ä¸€ä¸ªåŸå‹å…‹éš†è‡ªèº«ï¼Œä»è€Œåˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚åœ¨å®¢æˆ·ç±»ä¸­åªéœ€è¦ç›´æ¥å®ä¾‹åŒ–æˆ–é€šè¿‡å·¥å‚æ–¹æ³•ç­‰æ–¹å¼åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå†é€šè¿‡è°ƒç”¨è¯¥å¯¹è±¡çš„å…‹éš†æ–¹æ³•å¤åˆ¶å¾—åˆ°å¤šä¸ªç›¸åŒçš„å¯¹è±¡ã€‚

![1752980104052](images/5.åŸå‹æ¨¡å¼/1752980104052.png)

â€‹	åœ¨javaä¸­ï¼Œä»»ä½•ç±»éƒ½æ˜¯Objectçš„å­ç±»ï¼ŒObjectä¸­åˆ™é»˜è®¤å­˜åœ¨ä¸€ä¸ªæ–¹æ³•clone()ã€‚ä½†æ˜¯ä¸ºäº†æ›´ç¬¦åˆåŸå‹æ¨¡å¼å®šä¹‰ï¼Œä»¥åŠæ˜ç¡®å‘ŠçŸ¥ä½¿ç”¨æ–¹é‚£äº›ç±»å¯ä»¥ç›´æ¥è¿›è¡Œå…‹éš†ï¼Œä¸€èˆ¬å¯¹äºå¯ä»¥å…‹éš†çš„ç±»ï¼Œéƒ½è¦å®ç°ä¸€ä¸ªæ¥å£ï¼šCloneableï¼Œè¡¨ç¤ºå½“å‰ç±»å¯ä»¥è¿›è¡Œå…‹éš†ã€‚

![1752980081398](images/5.åŸå‹æ¨¡å¼/1752980081398.png)

### 2ã€æºç 

â€‹	ç°åœ¨ï¼Œå°†Mailç±»å®ç°Cloneableæ¥å£ï¼Œå¹¶è°ƒç”¨çˆ¶ç±»çš„clone()æ–¹æ³•ï¼š

~~~ java
// é‚®ä»¶
public class Mail implements Cloneable{
    private String title;

    private String content;

    private Attachment attachment;

    private Date date;

    @Override
    protected Mail clone() throws CloneNotSupportedException {
        return (Mail) super.clone();
    }
}
// é™„ä»¶
public class Attachment implements Cloneable{
    private String name;

    private String content;

    @Override
    public Attachment clone() {
        try {
            Attachment clone = (Attachment) super.clone();
            return clone;
        } catch (CloneNotSupportedException e) {
            throw new AssertionError();
        }
    }
}
~~~

â€‹	ç„¶åå®¢æˆ·ç«¯é€šè¿‡åˆ›å»ºçš„Mail1ä½œä¸ºåŸå‹ï¼Œå…‹éš†å‡ºé‚®ä»¶2

~~~ java
public class Client {

    public static void main(String[] args) {
        Date date = new Date();
        Attachment attachment = new Attachment();
        attachment.setName("é™„ä»¶");
        attachment.setContent("é™„ä»¶å†…å®¹");

        Mail mail1 = new Mail();
        mail1.setTitle("é‚®ä»¶1");
        mail1.setContent("é‚®ä»¶å†…å®¹");
        mail1.setDate(date);
        mail1.setAttachment(attachment);

        Mail mail2 = null;
        try {
            mail2 = mail1.clone();
        } catch (CloneNotSupportedException e) {
            throw new RuntimeException(e);
        }

        System.out.println(mail1 == mail2);
        System.out.println(mail1.getAttachment() == mail2.getAttachment());
        System.out.println(mail1.getTitle() == mail2.getTitle());
        System.out.println("é‚®ä»¶1ï¼š" + mail1);
        System.out.println("é‚®ä»¶2ï¼š" + mail2);
    }
}

// è¾“å‡ºç»“æœ
false
true
true
é‚®ä»¶1ï¼šMail{title='é‚®ä»¶1', content='é‚®ä»¶å†…å®¹', attachment=Attachment{name='é™„ä»¶', content='é™„ä»¶å†…å®¹'}, date=Sun Jul 20 21:52:36 CST 2025}
é‚®ä»¶2ï¼šMail{title='é‚®ä»¶1', content='é‚®ä»¶å†…å®¹', attachment=Attachment{name='é™„ä»¶', content='é™„ä»¶å†…å®¹'}, date=Sun Jul 20 21:52:36 CST 2025}
~~~

åˆ†æï¼š

â€‹	å¯è§ï¼Œä½¿ç”¨çˆ¶ç±»(Object)çš„cloneæ–¹æ³•ï¼Œè¿”å›å€¼é™¤äº†åŸå§‹å¯¹è±¡(Mail1å’ŒMail2)åœ°å€ä¸åŒå¤–ï¼Œå…¶å†…éƒ¨çš„å¼•ç”¨ç±»å‹å±æ€§å€¼å®é™…ä¸Šéƒ½æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼Œå³ä¸‹é¢è¯´çš„æµ…æ‹·è´ã€‚

### 3ã€æ·±å…‹éš†ä¸æµ…å…‹éš†

â€‹	é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªç±»åŒ…å«ä¸€äº›æˆå‘˜å¯¹è±¡ã€‚åœ¨ä½¿ç”¨åŸå‹æ¨¡å¼å…‹éš†å¯¹è±¡æ—¶ï¼Œæ ¹æ®å…¶æˆå‘˜å¯¹è±¡æ˜¯å¦ä¹Ÿå…‹éš†ï¼ŒåŸå‹æ¨¡å¼å¯ä»¥åˆ†ä¸ºä¸¤ç§å½¢å¼ï¼šæ·±å…‹éš†å’Œæµ…å…‹éš†ã€‚

**ï¼ˆ1ï¼‰æµ…å…‹éš†**

â€‹	åœ¨æµ…å…‹éš†ä¸­ï¼Œè¢«å¤åˆ¶å¯¹è±¡çš„æ‰€æœ‰æ™®é€šæˆå‘˜å˜é‡éƒ½å…·æœ‰ä¸åŸæ¥çš„å¯¹è±¡ç›¸åŒçš„å€¼ï¼Œè€Œæ‰€æœ‰çš„å¯¹å…¶ä»–å¯¹è±¡çš„å¼•ç”¨ä»ç„¶æŒ‡å‘åŸæ¥çš„å¯¹è±¡ã€‚

â€‹	æ¢è¨€ä¹‹ï¼Œæµ…å…‹éš†ä»…ä»…å¤åˆ¶æ‰€è€ƒè™‘çš„å¯¹è±¡ï¼Œè€Œä¸å¤åˆ¶å®ƒæ‰€å¼•ç”¨çš„æˆå‘˜å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯å…¶ä¸­çš„æˆå‘˜å¯¹è±¡å¹¶ä¸å¤åˆ¶ã€‚åœ¨æµ…å…‹éš†ä¸­ï¼Œå½“å¯¹è±¡è¢«å¤åˆ¶æ—¶å®ƒæ‰€åŒ…å«çš„æˆå‘˜å¯¹è±¡å´æ²¡æœ‰è¢«å¤åˆ¶.

â€‹	å› ä¸ºå®é™…ä¸Šä¸¤ä¸ªå¯¹è±¡çš„è¯¥æˆå‘˜å˜é‡éƒ½æŒ‡å‘åŒä¸€ä¸ªå®ä¾‹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåœ¨ä¸€ä¸ªå¯¹è±¡ä¸­ä¿®æ”¹è¯¥æˆå‘˜å˜é‡ä¼šå½±å“åˆ°å¦ä¸€ä¸ªå¯¹è±¡çš„è¯¥æˆå‘˜å˜é‡å€¼ã€‚

â€‹	å¦‚å›¾æ‰€ç¤ºï¼Œobj1ä¸ºåŸå‹å¯¹è±¡ï¼Œobj2ä¸ºå¤åˆ¶åçš„å¯¹è±¡ï¼ŒcontainedObj1å’ŒcontainedObj2ä¸ºæˆå‘˜å¯¹è±¡ã€‚

![1753020221146](images/5.åŸå‹æ¨¡å¼/1753020221146.png)
	
**ï¼ˆ2ï¼‰æ·±å…‹éš†**

â€‹	åœ¨æ·±å…‹éš†ä¸­ï¼Œè¢«å¤åˆ¶å¯¹è±¡çš„æ‰€æœ‰æ™®é€šæˆå‘˜å˜é‡ä¹Ÿéƒ½å«æœ‰ä¸åŸæ¥çš„å¯¹è±¡ç›¸åŒçš„å€¼ï¼Œé™¤å»é‚£äº›å¼•ç”¨å…¶ä»–å¯¹è±¡çš„å˜é‡ã€‚é‚£äº›å¼•ç”¨å…¶ä»–å¯¹è±¡çš„å˜é‡å°†æŒ‡å‘è¢«å¤åˆ¶è¿‡çš„æ–°å¯¹è±¡ï¼Œè€Œä¸å†æ˜¯åŸæœ‰çš„é‚£äº›è¢«å¼•ç”¨çš„å¯¹è±¡ã€‚

â€‹	æ¢è¨€ä¹‹ï¼Œæ·±å…‹éš†æŠŠè¦å¤åˆ¶çš„å¯¹è±¡æ‰€å¼•ç”¨çš„å¯¹è±¡éƒ½å¤åˆ¶äº†ä¸€éã€‚åœ¨æ·±å…‹éš†ä¸­ï¼Œé™¤äº†å¯¹è±¡æœ¬èº«è¢«å¤åˆ¶å¤–ï¼Œå¯¹è±¡åŒ…å«çš„å¼•ç”¨ä¹Ÿè¢«å¤åˆ¶ï¼Œä¹Ÿå°±æ˜¯å…¶ä¸­çš„æˆå‘˜å¯¹è±¡ä¹Ÿå°†å¤åˆ¶ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚

![1753020286395](images/5.åŸå‹æ¨¡å¼/1753020286395.png)





### 4ã€æ·±æ‹·è´çš„å®ç°æ–¹å¼

â€‹	ä¸Šé¢2ä¸­æºç å®ç°åˆ™æ˜¯æµ…æ‹·è´ï¼Œè¦å®ç°æ·±æ‹·è´æœ‰ä¸¤ç§æ–¹æ³•ï¼š

- é‡å†™cloneæ–¹æ³•ï¼Œä¸å†ä½¿ç”¨Objectçš„cloneï¼Œå¯¹æ¯ä¸€ä¸ªæˆå‘˜å¯¹è±¡éƒ½å•ç‹¬åˆ›å»ºèµ‹å€¼ã€‚
- é€šè¿‡**å¯¹è±¡åºåˆ—åŒ–**å®ç°æ·±æ‹·è´(æ¨è)

#### 4.1 é‡å†™clone

â€‹	é‚®ä»¶å’Œé™„ä»¶ç±»ï¼Œé‡å†™cloneç±»ï¼Œå¯¹æ¯ä¸ªæˆå‘˜å¯¹è±¡éƒ½è¿›è¡Œé‡å†™Newåˆ›å»ºã€‚

~~~ java
public class Attachment implements Cloneable{
    private String name;

    private String content;

    @Override
    public Attachment clone() {
        Attachment clone = new Attachment();
        clone.setName(new String(name));
        clone.setContent(new String(content));
        return clone;
    }
}

public class Mail implements Cloneable{
    private String title;

    private String content;

    private Attachment attachment;

    private Date date;

    @Override
    protected Mail clone() {
        Mail mail = new Mail();
        mail.setTitle(new String(title));
        mail.setContent(new String(content));
        mail.setAttachment(attachment.clone());
        mail.setDate(new Date(date.getTime()));
        return mail;
    }
}
~~~

å®¢æˆ·ç«¯

~~~ java
public class Client {
    public static void main(String[] args) {
        Date date = new Date();
        Attachment attachment = new Attachment();
        attachment.setName("é™„ä»¶");
        attachment.setContent("é™„ä»¶å†…å®¹");

        Mail mail1 = new Mail();
        mail1.setTitle("é‚®ä»¶1");
        mail1.setContent("é‚®ä»¶å†…å®¹");
        mail1.setDate(date);
        mail1.setAttachment(attachment);

        Mail mail2 =  mail1.clone();

        System.out.println(mail1 == mail2);
        System.out.println(mail1.getAttachment() == mail2.getAttachment());
        System.out.println(mail1.getTitle() == mail2.getTitle());
        System.out.println("é‚®ä»¶1ï¼š" + mail1);
        System.out.println("é‚®ä»¶2ï¼š" + mail2);
    }
}


// è¾“å‡ºï¼š
false
false
false
é‚®ä»¶1ï¼šMail{title='é‚®ä»¶1', content='é‚®ä»¶å†…å®¹', attachment=Attachment{name='é™„ä»¶', content='é™„ä»¶å†…å®¹'}, date=Sun Jul 20 22:17:44 CST 2025}
é‚®ä»¶2ï¼šMail{title='é‚®ä»¶1', content='é‚®ä»¶å†…å®¹', attachment=Attachment{name='é™„ä»¶', content='é™„ä»¶å†…å®¹'}, date=Sun Jul 20 22:17:44 CST 2025}
~~~

â€‹	å¯è§ï¼Œæ·±æ‹·è´å…‹éš†åï¼Œè¾“å‡ºå€¼éƒ½ç›¸åŒï¼Œä½†æ¯ä¸ªæˆå‘˜å¯¹è±¡éƒ½ä¸å†æŒ‡å‘åŒä¸€ä¸ªåœ°å€äº†ã€‚

#### 4.2 åºåˆ—åŒ–

â€‹	åœ¨Javaè¯­è¨€ä¸­ï¼Œåºåˆ—åŒ–ï¼ˆSerializationï¼‰å°±æ˜¯å°†å¯¹è±¡å†™åˆ°æµçš„è¿‡ç¨‹ï¼Œå†™åˆ°æµä¸­çš„å¯¹è±¡æ˜¯åŸæœ‰å¯¹è±¡çš„ä¸€ä¸ªæ‹·è´ï¼Œè€ŒåŸå¯¹è±¡ä»ç„¶å­˜åœ¨äºå†…å­˜ä¸­ã€‚

â€‹	é€šè¿‡åºåˆ—åŒ–å®ç°çš„æ‹·è´ä¸ä»…å¯ä»¥å¤åˆ¶å¯¹è±¡æœ¬èº«ï¼Œè€Œä¸”å¯ä»¥å¤åˆ¶å…¶å¼•ç”¨çš„æˆå‘˜å¯¹è±¡ï¼Œå› æ­¤é€šè¿‡åºåˆ—åŒ–å°†å¯¹è±¡å†™åˆ°ä¸€ä¸ªæµä¸­ï¼Œå†ä»æµé‡Œå°†å…¶è¯»å‡ºæ¥ï¼Œä»è€Œå®ç°æ·±å…‹éš†ã€‚

â€‹	éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**èƒ½å¤Ÿå®ç°åºåˆ—åŒ–çš„å¯¹è±¡å…¶ç±»å¿…é¡»å®ç°Serializableæ¥å£ï¼Œå¦åˆ™æ— æ³•å®ç°åºåˆ—åŒ–æ“ä½œ**ã€‚

â€‹	Javaè¯­è¨€æä¾›çš„Cloneableæ¥å£å’ŒSerializableæ¥å£å…¶ä»£ç éƒ½éå¸¸ç®€å•ï¼Œå®ƒä»¬æ˜¯ç©ºæ¥å£ã€‚

â€‹	**è¿™ç§ç©ºæ¥å£ä¹Ÿç§°ä¸ºæ ‡è¯†æ¥å£ï¼Œæ ‡è¯†æ¥å£ä¸­æ²¡æœ‰ä»»ä½•æ–¹æ³•çš„å®šä¹‰ï¼Œå…¶ä½œç”¨æ˜¯å‘Šè¯‰JREè¿™äº›æ¥å£çš„å®ç°ç±»æ˜¯å¦å…·æœ‰æŸä¸ªåŠŸèƒ½ï¼Œå¦‚æ˜¯å¦æ”¯æŒå…‹éš†ã€æ˜¯å¦æ”¯æŒåºåˆ—åŒ–ç­‰**ã€‚

**æºç ï¼š**

â€‹	å¯¹Mailæ–¹æ³•å®ç°deepCloneï¼Œè¿™é‡Œä¸æ”¹cloneæ–¹æ³•æ˜¯å› ä¸ºåŸå§‹çš„cloneæ–¹æ³•å·²ç»è¢«é‡å†™è¿›è¡Œæ·±æ‹·è´äº†ï¼Œè¿™é‡Œæ¼”ç¤ºå¦ä¸€ç§æ–¹å¼ã€‚

â€‹	åŒæ—¶ï¼ŒAttachmentä¹Ÿéœ€è¦å®ç°Serializableæ–¹æ³•ã€‚

~~~ java
public class Mail implements Cloneable, Serializable {
    private String title;
    private String content;
    private Attachment attachment;
    private Date date;
    /**
     * é€šè¿‡åºåˆ—åŒ–æ·±æ‹·è´
     */
    public Mail deepClone() {
        ByteArrayOutputStream bos = null;
        ObjectOutputStream oos = null;
        ByteArrayInputStream bis = null;
        ObjectInputStream ois = null;
        try {
            // å°†å¯¹è±¡å†™å…¥æµ
            bos = new ByteArrayOutputStream();
            oos = new ObjectOutputStream(bos);
            oos.writeObject(this);
            // å°†å¯¹è±¡ä»æµä¸­å–å‡º
            bis = new ByteArrayInputStream(bos.toByteArray());
            ois = new ObjectInputStream(bis);
            return (Mail) ois.readObject();
        } catch (IOException | ClassNotFoundException e) {
            throw new RuntimeException(e);
        } finally {
            try {
                if (bos != null) {
                    bos.close();
                }
                if (oos != null) {
                    oos.close();
                }
                if (bis != null) {
                    bis.close();
                }
                if (ois != null) {
                    ois.close();
                }
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }
}

public class Attachment implements Cloneable, Serializable {
    //...
}
~~~

å®¢æˆ·ç«¯ï¼š

~~~ java
public class Client {

    public static void main(String[] args) {
        Date date = new Date();
        Attachment attachment = new Attachment();
        attachment.setName("é™„ä»¶");
        attachment.setContent("é™„ä»¶å†…å®¹");

        Mail mail3 = mail1.deepClone();
        System.out.println(mail1 == mail3);
        System.out.println(mail1.getAttachment() == mail3.getAttachment());
        System.out.println(mail1.getTitle() == mail3.getTitle());
    }
}

// è¾“å‡ºï¼š
false
false
false
~~~



## ä¼˜ç‚¹ä¸ç¼ºç‚¹

**ä¼˜ç‚¹**

ï¼ˆ1ï¼‰å½“åˆ›å»ºæ–°çš„å¯¹è±¡å®ä¾‹è¾ƒä¸ºå¤æ‚æ—¶ï¼Œä½¿ç”¨åŸå‹æ¨¡å¼å¯ä»¥ç®€åŒ–å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹ï¼Œé€šè¿‡ä¸€ä¸ªå·²æœ‰å®ä¾‹å¯ä»¥æé«˜æ–°å®ä¾‹çš„åˆ›å»ºæ•ˆç‡ã€‚

ï¼ˆ2ï¼‰å¯ä»¥åŠ¨æ€å¢åŠ æˆ–å‡å°‘äº§å“ç±»ã€‚ç”±äºåˆ›å»ºäº§å“ç±»å®ä¾‹çš„æ–¹æ³•æ˜¯äº§å“ç±»ï¼ˆå…·ä½“åŸå‹ç±»ï¼‰å†…éƒ¨å…·æœ‰çš„ï¼Œå› æ­¤å¢åŠ æ–°äº§å“å¯¹æ•´ä¸ªç»“æ„æ²¡æœ‰å½±å“ã€‚åœ¨åŸå‹æ¨¡å¼ä¸­æä¾›äº†æŠ½è±¡åŸå‹ç±»ï¼Œåœ¨å®¢æˆ·ç«¯å¯ä»¥é’ˆå¯¹æŠ½è±¡åŸå‹ç±»è¿›è¡Œç¼–ç¨‹ï¼Œè€Œå°†å…·ä½“åŸå‹ç±»å†™åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œå¢åŠ æˆ–å‡å°‘äº§å“ç±»å¯¹åŸæœ‰ç³»ç»Ÿéƒ½æ²¡æœ‰ä»»ä½•å½±å“ã€‚

ï¼ˆ3ï¼‰åŸå‹æ¨¡å¼æä¾›äº†ç®€åŒ–çš„åˆ›å»ºç»“æ„ã€‚å·¥å‚æ–¹æ³•æ¨¡å¼å¸¸å¸¸éœ€è¦æœ‰ä¸€ä¸ªä¸äº§å“ç±»ç­‰çº§ç»“æ„ç›¸åŒçš„ç­‰çº§ç»“æ„ï¼Œè€ŒåŸå‹æ¨¡å¼å°±ä¸éœ€è¦è¿™æ ·ï¼ŒåŸå‹æ¨¡å¼ä¸­äº§å“çš„å¤åˆ¶æ˜¯é€šè¿‡å°è£…åœ¨åŸå‹ç±»ä¸­çš„clone()æ–¹æ³•å®ç°çš„ï¼Œæ— é¡»ä¸“é—¨çš„å·¥å‚ç±»æ¥åˆ›å»ºäº§å“ã€‚

ï¼ˆ4ï¼‰å¯ä»¥ä½¿ç”¨æ·±å…‹éš†çš„æ–¹å¼ä¿å­˜å¯¹è±¡çš„çŠ¶æ€ã€‚ä½¿ç”¨åŸå‹æ¨¡å¼å°†å¯¹è±¡å¤åˆ¶ä¸€ä»½å¹¶å°†å…¶çŠ¶æ€ä¿å­˜èµ·æ¥ï¼Œä»¥ä¾¿åœ¨éœ€è¦çš„æ—¶å€™ä½¿ç”¨ï¼ˆå¦‚æ¢å¤åˆ°æŸä¸€å†å²çŠ¶æ€ï¼‰ã€‚

**ç¼ºç‚¹**

ï¼ˆ1ï¼‰éœ€è¦ä¸ºæ¯ä¸€ä¸ªç±»é…å¤‡ä¸€ä¸ªå…‹éš†æ–¹æ³•ï¼Œè€Œä¸”è¿™ä¸ªå…‹éš†æ–¹æ³•éœ€è¦å¯¹ç±»çš„åŠŸèƒ½è¿›è¡Œé€šç›˜è€ƒè™‘ï¼Œè¿™å¯¹å…¨æ–°çš„ç±»æ¥è¯´ä¸æ˜¯å¾ˆéš¾ï¼Œä½†å¯¹å·²æœ‰çš„ç±»è¿›è¡Œæ”¹é€ æ—¶ï¼Œä¸ä¸€å®šæ˜¯ä»¶å®¹æ˜“çš„äº‹ï¼Œå¿…é¡»ä¿®æ”¹å…¶æºä»£ç ï¼Œè¿èƒŒäº†â€œå¼€é—­åŸåˆ™â€ã€‚

ï¼ˆ2ï¼‰åœ¨å®ç°æ·±å…‹éš†æ—¶éœ€è¦ç¼–å†™è¾ƒä¸ºå¤æ‚çš„ä»£ç ã€‚



## é€‚ç”¨åœºæ™¯

ï¼ˆ1ï¼‰åˆ›å»ºæ–°å¯¹è±¡æˆæœ¬è¾ƒå¤§ï¼ˆå¦‚åˆå§‹åŒ–éœ€è¦å ç”¨è¾ƒé•¿çš„æ—¶é—´ï¼Œå ç”¨å¤ªå¤šçš„CPUèµ„æºæˆ–ç½‘ç»œèµ„æºï¼‰ï¼Œæ–°çš„å¯¹è±¡å¯ä»¥é€šè¿‡åŸå‹æ¨¡å¼å¯¹å·²æœ‰å¯¹è±¡è¿›è¡Œå¤åˆ¶æ¥è·å¾—ï¼Œå¦‚æœæ˜¯ç›¸ä¼¼å¯¹è±¡ï¼Œåˆ™å¯ä»¥å¯¹å…¶å±æ€§ç¨ä½œä¿®æ”¹ã€‚

ï¼ˆ2ï¼‰å¦‚æœç³»ç»Ÿè¦ä¿å­˜å¯¹è±¡çš„çŠ¶æ€ï¼Œè€Œå¯¹è±¡çš„çŠ¶æ€å˜åŒ–å¾ˆå°ï¼Œæˆ–è€…å¯¹è±¡æœ¬èº«å å†…å­˜ä¸å¤§çš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åŸå‹æ¨¡å¼é…åˆå¤‡å¿˜å½•æ¨¡å¼ï¼ˆç¬¬22ç« å°†ä»‹ç»å¤‡å¿˜å½•æ¨¡å¼ï¼‰æ¥åº”ç”¨ã€‚ç›¸åï¼Œå¦‚æœå¯¹è±¡çš„çŠ¶æ€å˜åŒ–å¾ˆå¤§ï¼Œæˆ–è€…å¯¹è±¡å ç”¨çš„å†…å­˜å¾ˆå¤§ï¼Œé‚£ä¹ˆé‡‡ç”¨çŠ¶æ€æ¨¡å¼ä¼šæ¯”åŸå‹æ¨¡å¼æ›´å¥½ã€‚

ï¼ˆ3ï¼‰éœ€è¦é¿å…ä½¿ç”¨åˆ†å±‚æ¬¡çš„å·¥å‚ç±»æ¥åˆ›å»ºåˆ†å±‚æ¬¡çš„å¯¹è±¡ï¼Œå¹¶ä¸”ç±»çš„å®ä¾‹å¯¹è±¡åªæœ‰ä¸€ä¸ªæˆ–å¾ˆå°‘çš„å‡ ä¸ªç»„åˆçŠ¶æ€ï¼Œé€šè¿‡å¤åˆ¶åŸå‹å¯¹è±¡å¾—åˆ°æ–°å®ä¾‹å¯èƒ½æ¯”ä½¿ç”¨æ„é€ å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°å®ä¾‹æ›´åŠ æ–¹ä¾¿ã€‚

## åº”ç”¨

### 1ã€springæºç ä¸­åˆ›å»ºbean

#### ğŸ”§1. ç¼–å†™ç¤ºä¾‹ Beanï¼Œè§‚å¯Ÿå®ä¾‹åŒ–è¡Œä¸º

åˆ†åˆ«å®šä¹‰ä¸¤ä¸ª Beanï¼Œä½œç”¨åŸŸä¸º `"singleton"` å’Œ `"prototype"`ï¼Œå¹¶åœ¨æ„é€ æ–¹æ³•å’Œ `@PostConstruct` æ–¹æ³•ä¸­åŠ å…¥æ‰“å°è¯­å¥ï¼Œä»¥ä¾¿è§‚å¯Ÿ Bean çš„åˆ›å»ºå’Œåˆå§‹åŒ–æ¬¡æ•°ï¼š

```java
// å•ä¾‹ Beanï¼šé»˜è®¤ä½œç”¨åŸŸï¼Œæ•´ä¸ªå®¹å™¨ä¸­ä»…åˆ›å»ºä¸€æ¬¡å®ä¾‹
@Component
@Scope(ConfigurableBeanFactory.SCOPE_SINGLETON)
public class SingletonBean {
    public SingletonBean() {
        System.out.println("åˆ›å»º SingletonBean");
    }

    @PostConstruct
    public void init() {
        System.out.println("åˆå§‹åŒ– SingletonBean");
    }
}

// åŸå‹ Beanï¼šæ¯æ¬¡æ³¨å…¥æˆ– getBean() è°ƒç”¨éƒ½ä¼šåˆ›å»ºæ–°å®ä¾‹
@Component
@Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE)
public class PrototypeBean {
    public PrototypeBean() {
        System.out.println("åˆ›å»º PrototypeBean");
    }

    @PostConstruct
    public void init() {
        System.out.println("åˆå§‹åŒ– PrototypeBean");
    }
}
```

------

####  ğŸš€ 2. å¤šæ¬¡è·å– Bean å®ä¾‹ï¼ŒéªŒè¯åŸå‹è¡Œä¸º

ä» Spring å®¹å™¨ä¸­å¤šæ¬¡è·å–è¿™ä¸¤ä¸ª Beanï¼Œå¹¶è§‚å¯Ÿè¾“å‡ºæ—¥å¿—ï¼š

```java
@Autowired
private ApplicationContext applicationContext;

@Override
public void beanTest() {
    SingletonBean singletonBean1 = applicationContext.getBean(SingletonBean.class);
    SingletonBean singletonBean2 = applicationContext.getBean(SingletonBean.class);

    PrototypeBean prototypeBean1 = applicationContext.getBean(PrototypeBean.class);
    PrototypeBean prototypeBean2 = applicationContext.getBean(PrototypeBean.class);
}
```

##### âœ… è§‚å¯Ÿç»“æœ

- `SingletonBean` åªåˆ›å»ºå’Œåˆå§‹åŒ–ä¸€æ¬¡ï¼›
- `PrototypeBean` æ¯æ¬¡è°ƒç”¨ `getBean()` éƒ½é‡æ–°å®ä¾‹åŒ–ï¼Œ`@PostConstruct` æ–¹æ³•ä¹Ÿè¢«è°ƒç”¨å¤šæ¬¡ã€‚

<small>ç¤ºæ„å›¾ï¼š</small>
![1752677657413](images/5.åŸå‹æ¨¡å¼/1752677657413.png)



------

#### ğŸ” 3. Spring æºç åˆ†æï¼šåŸå‹æ¨¡å¼çš„ä½“ç°

Spring çš„ `getBean()` è°ƒç”¨é“¾å¦‚ä¸‹ï¼š

```text
DefaultListableBeanFactory.getBean(name)
  â†’ AbstractBeanFactory.getBean(name)
    â†’ doGetBean(name, ...)
      â†’ createBean(name, mbd, args)  
        â†’ doCreateBean(name, mbd, args)
```

------

##### ğŸ“Œ æ ¸å¿ƒé€»è¾‘ä½äº `AbstractBeanFactory#doGetBean`ï¼š

```java
// Create bean instance.
if (mbd.isSingleton()) {
    sharedInstance = getSingleton(beanName, () -> {
        try {
            return createBean(beanName, mbd, args);
        }
        catch (BeansException ex) {
            // Explicitly remove instance from singleton cache: It might have been put there
            // eagerly by the creation process, to allow for circular reference resolution.
            // Also remove any beans that received a temporary reference to the bean.
            destroySingleton(beanName);
            throw ex;
        }
    });
    beanInstance = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);
}

else if (mbd.isPrototype()) {
    // It's a prototype -> create a new instance.
    Object prototypeInstance = null;
    try {
        beforePrototypeCreation(beanName);
        prototypeInstance = createBean(beanName, mbd, args);
    }
    finally {
        afterPrototypeCreation(beanName);
    }
    beanInstance = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);
}

else {
    // .....
}
```

![1752679304993](images/5.åŸå‹æ¨¡å¼/1752679304993.png)

##### ğŸ§  åˆ†æè¦ç‚¹ï¼š

| ç‰¹æ€§                 | è¡Œä¸º                                                       |
| -------------------- | ---------------------------------------------------------- |
| âœ… æ¯æ¬¡åˆ›å»ºæ–°å®ä¾‹     | æ¯æ¬¡ `getBean()` éƒ½æ‰§è¡Œ `createBean()`ï¼Œä¸ä¼šä»ç¼“å­˜ä¸­è·å–   |
| âœ… æ”¯æŒå®Œæ•´åˆå§‹åŒ–æµç¨‹ | ä»ç„¶è°ƒç”¨æ„é€ æ–¹æ³•ã€`@PostConstruct`ã€`BeanPostProcessor` ç­‰ |
| âŒ ä¸ç¼“å­˜å®ä¾‹         | ä¸åŠ å…¥å•ä¾‹æ± ï¼Œä¸æ‰˜ç®¡é”€æ¯                                   |
| âŒ ä¸æ”¯æŒå¾ªç¯ä¾èµ–     | ä¸æ”¯æŒæå‰æš´éœ²æ—©æœŸå¼•ç”¨ï¼Œå› æ­¤æ— æ³•è§£å†³åŸå‹ Bean çš„å¾ªç¯ä¾èµ–   |

#### âœ… æ€»ç»“

Spring ä¸­åŸå‹æ¨¡å¼çš„å®ç°ï¼Œä¸ä¾èµ–æŸä¸ªç‰¹å®šçš„ç±»æˆ–è®¾è®¡ï¼Œè€Œæ˜¯é€šè¿‡ **æ¯æ¬¡éƒ½åˆ›å»ºæ–°å®ä¾‹** çš„æ§åˆ¶æµç¨‹ä½“ç°å‡ºæ¥ã€‚åœ¨æºç ä¸­ä¸»è¦ä½“ç°åœ¨ï¼š

- `doGetBean()` ä¸­å¯¹ `isPrototype()` çš„åˆ¤æ–­ï¼Œæ¯æ¬¡ç›´æ¥è°ƒç”¨ `createBean()`ï¼›
- ä¸å•ä¾‹æ¨¡å¼ä¸åŒï¼Œä¸ä½¿ç”¨ç¼“å­˜ã€ä¸æ³¨å†Œé”€æ¯å›è°ƒã€ä¸è§£å†³å¾ªç¯ä¾èµ–ï¼›
- ä½†åˆ›å»ºæµç¨‹æœ¬èº«ï¼ˆ`createBean â†’ doCreateBean`ï¼‰ä»ç„¶å®Œæ•´æ‰§è¡Œå®ä¾‹åŒ–ã€ä¾èµ–æ³¨å…¥ã€åˆå§‹åŒ–é€»è¾‘ã€‚



### 2ã€å¤åˆ¶ç²˜è´´

â€‹	åŸå‹æ¨¡å¼åº”ç”¨äºå¾ˆå¤šè½¯ä»¶ä¸­ï¼Œå¦‚æœæ¯æ¬¡åˆ›å»ºä¸€ä¸ªå¯¹è±¡è¦èŠ±å¤§é‡æ—¶é—´ï¼ŒåŸå‹æ¨¡å¼æ˜¯æœ€å¥½çš„è§£å†³æ–¹æ¡ˆã€‚å¾ˆå¤šè½¯ä»¶æä¾›çš„å¤åˆ¶ï¼ˆCtrlåCé”®ï¼‰å’Œç²˜è´´ï¼ˆCtrlåVé”®ï¼‰æ“ä½œå°±æ˜¯åŸå‹æ¨¡å¼çš„åº”ç”¨ï¼Œå¤åˆ¶å¾—åˆ°çš„å¯¹è±¡ä¸åŸå‹å¯¹è±¡æ˜¯ä¸¤ä¸ªç±»å‹ç›¸åŒä½†å†…å­˜åœ°å€ä¸åŒçš„å¯¹è±¡ï¼Œé€šè¿‡åŸå‹æ¨¡å¼å¯ä»¥å¤§å¤§æé«˜å¯¹è±¡çš„åˆ›å»ºæ•ˆç‡ã€‚

